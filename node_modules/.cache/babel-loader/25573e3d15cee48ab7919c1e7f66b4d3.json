{"ast":null,"code":"var Crypto = require('crypto');\n\nvar Events = require('events');\n\nvar Net = require('net');\n\nvar tls = require('tls');\n\nvar ConnectionConfig = require('./ConnectionConfig');\n\nvar Protocol = require('./protocol/Protocol');\n\nvar SqlString = require('./protocol/SqlString');\n\nvar Query = require('./protocol/sequences/Query');\n\nvar Util = require('util');\n\nmodule.exports = Connection;\nUtil.inherits(Connection, Events.EventEmitter);\n\nfunction Connection(options) {\n  Events.EventEmitter.call(this);\n  this.config = options.config;\n  this._socket = options.socket;\n  this._protocol = new Protocol({\n    config: this.config,\n    connection: this\n  });\n  this._connectCalled = false;\n  this.state = 'disconnected';\n  this.threadId = null;\n}\n\nConnection.createQuery = function createQuery(sql, values, callback) {\n  if (sql instanceof Query) {\n    return sql;\n  }\n\n  var cb = callback;\n  var options = {};\n\n  if (typeof sql === 'function') {\n    cb = sql;\n  } else if (typeof sql === 'object') {\n    options = Object.create(sql);\n\n    if (typeof values === 'function') {\n      cb = values;\n    } else if (values !== undefined) {\n      Object.defineProperty(options, 'values', {\n        value: values\n      });\n    }\n  } else {\n    options.sql = sql;\n\n    if (typeof values === 'function') {\n      cb = values;\n    } else if (values !== undefined) {\n      options.values = values;\n    }\n  }\n\n  if (cb !== undefined) {\n    cb = wrapCallbackInDomain(null, cb);\n\n    if (cb === undefined) {\n      throw new TypeError('argument callback must be a function when provided');\n    }\n  }\n\n  return new Query(options, cb);\n};\n\nConnection.prototype.connect = function connect(options, callback) {\n  if (!callback && typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  if (!this._connectCalled) {\n    this._connectCalled = true; // Connect either via a UNIX domain socket or a TCP socket.\n\n    this._socket = this.config.socketPath ? Net.createConnection(this.config.socketPath) : Net.createConnection(this.config.port, this.config.host); // Connect socket to connection domain\n\n    if (Events.usingDomains) {\n      this._socket.domain = this.domain;\n    }\n\n    var connection = this;\n\n    this._protocol.on('data', function (data) {\n      connection._socket.write(data);\n    });\n\n    this._socket.on('data', wrapToDomain(connection, function (data) {\n      connection._protocol.write(data);\n    }));\n\n    this._protocol.on('end', function () {\n      connection._socket.end();\n    });\n\n    this._socket.on('end', wrapToDomain(connection, function () {\n      connection._protocol.end();\n    }));\n\n    this._socket.on('error', this._handleNetworkError.bind(this));\n\n    this._socket.on('connect', this._handleProtocolConnect.bind(this));\n\n    this._protocol.on('handshake', this._handleProtocolHandshake.bind(this));\n\n    this._protocol.on('initialize', this._handleProtocolInitialize.bind(this));\n\n    this._protocol.on('unhandledError', this._handleProtocolError.bind(this));\n\n    this._protocol.on('drain', this._handleProtocolDrain.bind(this));\n\n    this._protocol.on('end', this._handleProtocolEnd.bind(this));\n\n    this._protocol.on('enqueue', this._handleProtocolEnqueue.bind(this));\n\n    if (this.config.connectTimeout) {\n      var handleConnectTimeout = this._handleConnectTimeout.bind(this);\n\n      this._socket.setTimeout(this.config.connectTimeout, handleConnectTimeout);\n\n      this._socket.once('connect', function () {\n        this.setTimeout(0, handleConnectTimeout);\n      });\n    }\n  }\n\n  this._protocol.handshake(options, wrapCallbackInDomain(this, callback));\n};\n\nConnection.prototype.changeUser = function changeUser(options, callback) {\n  if (!callback && typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  this._implyConnect();\n\n  var charsetNumber = options.charset ? ConnectionConfig.getCharsetNumber(options.charset) : this.config.charsetNumber;\n  return this._protocol.changeUser({\n    user: options.user || this.config.user,\n    password: options.password || this.config.password,\n    database: options.database || this.config.database,\n    timeout: options.timeout,\n    charsetNumber: charsetNumber,\n    currentConfig: this.config\n  }, wrapCallbackInDomain(this, callback));\n};\n\nConnection.prototype.beginTransaction = function beginTransaction(options, callback) {\n  if (!callback && typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  options = options || {};\n  options.sql = 'START TRANSACTION';\n  options.values = null;\n  return this.query(options, callback);\n};\n\nConnection.prototype.commit = function commit(options, callback) {\n  if (!callback && typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  options = options || {};\n  options.sql = 'COMMIT';\n  options.values = null;\n  return this.query(options, callback);\n};\n\nConnection.prototype.rollback = function rollback(options, callback) {\n  if (!callback && typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  options = options || {};\n  options.sql = 'ROLLBACK';\n  options.values = null;\n  return this.query(options, callback);\n};\n\nConnection.prototype.query = function query(sql, values, cb) {\n  var query = Connection.createQuery(sql, values, cb);\n  query._connection = this;\n\n  if (!(typeof sql === 'object' && 'typeCast' in sql)) {\n    query.typeCast = this.config.typeCast;\n  }\n\n  if (query.sql) {\n    query.sql = this.format(query.sql, query.values);\n  }\n\n  if (query._callback) {\n    query._callback = wrapCallbackInDomain(this, query._callback);\n  }\n\n  this._implyConnect();\n\n  return this._protocol._enqueue(query);\n};\n\nConnection.prototype.ping = function ping(options, callback) {\n  if (!callback && typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  this._implyConnect();\n\n  this._protocol.ping(options, wrapCallbackInDomain(this, callback));\n};\n\nConnection.prototype.statistics = function statistics(options, callback) {\n  if (!callback && typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  this._implyConnect();\n\n  this._protocol.stats(options, wrapCallbackInDomain(this, callback));\n};\n\nConnection.prototype.end = function end(options, callback) {\n  var cb = callback;\n  var opts = options;\n\n  if (!callback && typeof options === 'function') {\n    cb = options;\n    opts = null;\n  } // create custom options reference\n\n\n  opts = Object.create(opts || null);\n\n  if (opts.timeout === undefined) {\n    // default timeout of 30 seconds\n    opts.timeout = 30000;\n  }\n\n  this._implyConnect();\n\n  this._protocol.quit(opts, wrapCallbackInDomain(this, cb));\n};\n\nConnection.prototype.destroy = function () {\n  this.state = 'disconnected';\n\n  this._implyConnect();\n\n  this._socket.destroy();\n\n  this._protocol.destroy();\n};\n\nConnection.prototype.pause = function () {\n  this._socket.pause();\n\n  this._protocol.pause();\n};\n\nConnection.prototype.resume = function () {\n  this._socket.resume();\n\n  this._protocol.resume();\n};\n\nConnection.prototype.escape = function (value) {\n  return SqlString.escape(value, false, this.config.timezone);\n};\n\nConnection.prototype.escapeId = function escapeId(value) {\n  return SqlString.escapeId(value, false);\n};\n\nConnection.prototype.format = function (sql, values) {\n  if (typeof this.config.queryFormat === 'function') {\n    return this.config.queryFormat.call(this, sql, values, this.config.timezone);\n  }\n\n  return SqlString.format(sql, values, this.config.stringifyObjects, this.config.timezone);\n};\n\nif (tls.TLSSocket) {\n  // 0.11+ environment\n  Connection.prototype._startTLS = function _startTLS(onSecure) {\n    var connection = this;\n    createSecureContext(this.config, function (err, secureContext) {\n      if (err) {\n        onSecure(err);\n        return;\n      } // \"unpipe\"\n\n\n      connection._socket.removeAllListeners('data');\n\n      connection._protocol.removeAllListeners('data'); // socket <-> encrypted\n\n\n      var rejectUnauthorized = connection.config.ssl.rejectUnauthorized;\n      var secureEstablished = false;\n      var secureSocket = new tls.TLSSocket(connection._socket, {\n        rejectUnauthorized: rejectUnauthorized,\n        requestCert: true,\n        secureContext: secureContext,\n        isServer: false\n      }); // error handler for secure socket\n\n      secureSocket.on('_tlsError', function (err) {\n        if (secureEstablished) {\n          connection._handleNetworkError(err);\n        } else {\n          onSecure(err);\n        }\n      }); // cleartext <-> protocol\n\n      secureSocket.pipe(connection._protocol);\n\n      connection._protocol.on('data', function (data) {\n        secureSocket.write(data);\n      });\n\n      secureSocket.on('secure', function () {\n        secureEstablished = true;\n        onSecure(rejectUnauthorized ? this.ssl.verifyError() : null);\n      }); // start TLS communications\n\n      secureSocket._start();\n    });\n  };\n} else {\n  // pre-0.11 environment\n  Connection.prototype._startTLS = function _startTLS(onSecure) {\n    // before TLS:\n    //  _socket <-> _protocol\n    // after:\n    //  _socket <-> securePair.encrypted <-> securePair.cleartext <-> _protocol\n    var connection = this;\n    var credentials = Crypto.createCredentials({\n      ca: this.config.ssl.ca,\n      cert: this.config.ssl.cert,\n      ciphers: this.config.ssl.ciphers,\n      key: this.config.ssl.key,\n      passphrase: this.config.ssl.passphrase\n    });\n    var rejectUnauthorized = this.config.ssl.rejectUnauthorized;\n    var secureEstablished = false;\n    var securePair = tls.createSecurePair(credentials, false, true, rejectUnauthorized); // error handler for secure pair\n\n    securePair.on('error', function (err) {\n      if (secureEstablished) {\n        connection._handleNetworkError(err);\n      } else {\n        onSecure(err);\n      }\n    }); // \"unpipe\"\n\n    this._socket.removeAllListeners('data');\n\n    this._protocol.removeAllListeners('data'); // socket <-> encrypted\n\n\n    securePair.encrypted.pipe(this._socket);\n\n    this._socket.on('data', function (data) {\n      securePair.encrypted.write(data);\n    }); // cleartext <-> protocol\n\n\n    securePair.cleartext.pipe(this._protocol);\n\n    this._protocol.on('data', function (data) {\n      securePair.cleartext.write(data);\n    }); // secure established\n\n\n    securePair.on('secure', function () {\n      secureEstablished = true;\n\n      if (!rejectUnauthorized) {\n        onSecure();\n        return;\n      }\n\n      var verifyError = this.ssl.verifyError();\n      var err = verifyError; // node.js 0.6 support\n\n      if (typeof err === 'string') {\n        err = new Error(verifyError);\n        err.code = verifyError;\n      }\n\n      onSecure(err);\n    }); // node.js 0.8 bug\n\n    securePair._cycle = securePair.cycle;\n\n    securePair.cycle = function cycle() {\n      if (this.ssl && this.ssl.error) {\n        this.error();\n      }\n\n      return this._cycle.apply(this, arguments);\n    };\n  };\n}\n\nConnection.prototype._handleConnectTimeout = function () {\n  if (this._socket) {\n    this._socket.setTimeout(0);\n\n    this._socket.destroy();\n  }\n\n  var err = new Error('connect ETIMEDOUT');\n  err.errorno = 'ETIMEDOUT';\n  err.code = 'ETIMEDOUT';\n  err.syscall = 'connect';\n\n  this._handleNetworkError(err);\n};\n\nConnection.prototype._handleNetworkError = function (err) {\n  this._protocol.handleNetworkError(err);\n};\n\nConnection.prototype._handleProtocolError = function (err) {\n  this.state = 'protocol_error';\n  this.emit('error', err);\n};\n\nConnection.prototype._handleProtocolDrain = function () {\n  this.emit('drain');\n};\n\nConnection.prototype._handleProtocolConnect = function () {\n  this.state = 'connected';\n  this.emit('connect');\n};\n\nConnection.prototype._handleProtocolHandshake = function _handleProtocolHandshake() {\n  this.state = 'authenticated';\n};\n\nConnection.prototype._handleProtocolInitialize = function _handleProtocolInitialize(packet) {\n  this.threadId = packet.threadId;\n};\n\nConnection.prototype._handleProtocolEnd = function (err) {\n  this.state = 'disconnected';\n  this.emit('end', err);\n};\n\nConnection.prototype._handleProtocolEnqueue = function _handleProtocolEnqueue(sequence) {\n  this.emit('enqueue', sequence);\n};\n\nConnection.prototype._implyConnect = function () {\n  if (!this._connectCalled) {\n    this.connect();\n  }\n};\n\nfunction createSecureContext(config, cb) {\n  var context = null;\n  var error = null;\n\n  try {\n    context = tls.createSecureContext({\n      ca: config.ssl.ca,\n      cert: config.ssl.cert,\n      ciphers: config.ssl.ciphers,\n      key: config.ssl.key,\n      passphrase: config.ssl.passphrase\n    });\n  } catch (err) {\n    error = err;\n  }\n\n  cb(error, context);\n}\n\nfunction unwrapFromDomain(fn) {\n  return function () {\n    var domains = [];\n    var ret;\n\n    while (process.domain) {\n      domains.shift(process.domain);\n      process.domain.exit();\n    }\n\n    try {\n      ret = fn.apply(this, arguments);\n    } finally {\n      for (var i = 0; i < domains.length; i++) {\n        domains[i].enter();\n      }\n    }\n\n    return ret;\n  };\n}\n\nfunction wrapCallbackInDomain(ee, fn) {\n  if (typeof fn !== 'function') {\n    return undefined;\n  }\n\n  if (fn.domain) {\n    return fn;\n  }\n\n  var domain = process.domain;\n\n  if (domain) {\n    return domain.bind(fn);\n  } else if (ee) {\n    return unwrapFromDomain(wrapToDomain(ee, fn));\n  } else {\n    return fn;\n  }\n}\n\nfunction wrapToDomain(ee, fn) {\n  return function () {\n    if (Events.usingDomains && ee.domain) {\n      ee.domain.enter();\n      fn.apply(this, arguments);\n      ee.domain.exit();\n    } else {\n      fn.apply(this, arguments);\n    }\n  };\n}","map":{"version":3,"sources":["C:/inetpub/wwwroot/ThesisProject/node_modules/mysql/lib/Connection.js"],"names":["Crypto","require","Events","Net","tls","ConnectionConfig","Protocol","SqlString","Query","Util","module","exports","Connection","inherits","EventEmitter","options","call","config","_socket","socket","_protocol","connection","_connectCalled","state","threadId","createQuery","sql","values","callback","cb","Object","create","undefined","defineProperty","value","wrapCallbackInDomain","TypeError","prototype","connect","socketPath","createConnection","port","host","usingDomains","domain","on","data","write","wrapToDomain","end","_handleNetworkError","bind","_handleProtocolConnect","_handleProtocolHandshake","_handleProtocolInitialize","_handleProtocolError","_handleProtocolDrain","_handleProtocolEnd","_handleProtocolEnqueue","connectTimeout","handleConnectTimeout","_handleConnectTimeout","setTimeout","once","handshake","changeUser","_implyConnect","charsetNumber","charset","getCharsetNumber","user","password","database","timeout","currentConfig","beginTransaction","query","commit","rollback","_connection","typeCast","format","_callback","_enqueue","ping","statistics","stats","opts","quit","destroy","pause","resume","escape","timezone","escapeId","queryFormat","stringifyObjects","TLSSocket","_startTLS","onSecure","createSecureContext","err","secureContext","removeAllListeners","rejectUnauthorized","ssl","secureEstablished","secureSocket","requestCert","isServer","pipe","verifyError","_start","credentials","createCredentials","ca","cert","ciphers","key","passphrase","securePair","createSecurePair","encrypted","cleartext","Error","code","_cycle","cycle","error","apply","arguments","errorno","syscall","handleNetworkError","emit","packet","sequence","context","unwrapFromDomain","fn","domains","ret","process","shift","exit","i","length","enter","ee"],"mappings":"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","sourcesContent":["var Crypto           = require('crypto');\r\nvar Events           = require('events');\r\nvar Net              = require('net');\r\nvar tls              = require('tls');\r\nvar ConnectionConfig = require('./ConnectionConfig');\r\nvar Protocol         = require('./protocol/Protocol');\r\nvar SqlString        = require('./protocol/SqlString');\r\nvar Query            = require('./protocol/sequences/Query');\r\nvar Util             = require('util');\r\n\r\nmodule.exports = Connection;\r\nUtil.inherits(Connection, Events.EventEmitter);\r\nfunction Connection(options) {\r\n  Events.EventEmitter.call(this);\r\n\r\n  this.config = options.config;\r\n\r\n  this._socket        = options.socket;\r\n  this._protocol      = new Protocol({config: this.config, connection: this});\r\n  this._connectCalled = false;\r\n  this.state          = 'disconnected';\r\n  this.threadId       = null;\r\n}\r\n\r\nConnection.createQuery = function createQuery(sql, values, callback) {\r\n  if (sql instanceof Query) {\r\n    return sql;\r\n  }\r\n\r\n  var cb      = callback;\r\n  var options = {};\r\n\r\n  if (typeof sql === 'function') {\r\n    cb = sql;\r\n  } else if (typeof sql === 'object') {\r\n    options = Object.create(sql);\r\n\r\n    if (typeof values === 'function') {\r\n      cb = values;\r\n    } else if (values !== undefined) {\r\n      Object.defineProperty(options, 'values', { value: values });\r\n    }\r\n  } else {\r\n    options.sql = sql;\r\n\r\n    if (typeof values === 'function') {\r\n      cb = values;\r\n    } else if (values !== undefined) {\r\n      options.values = values;\r\n    }\r\n  }\r\n\r\n  if (cb !== undefined) {\r\n    cb = wrapCallbackInDomain(null, cb);\r\n\r\n    if (cb === undefined) {\r\n      throw new TypeError('argument callback must be a function when provided');\r\n    }\r\n  }\r\n\r\n  return new Query(options, cb);\r\n};\r\n\r\nConnection.prototype.connect = function connect(options, callback) {\r\n  if (!callback && typeof options === 'function') {\r\n    callback = options;\r\n    options = {};\r\n  }\r\n\r\n  if (!this._connectCalled) {\r\n    this._connectCalled = true;\r\n\r\n    // Connect either via a UNIX domain socket or a TCP socket.\r\n    this._socket = (this.config.socketPath)\r\n      ? Net.createConnection(this.config.socketPath)\r\n      : Net.createConnection(this.config.port, this.config.host);\r\n\r\n    // Connect socket to connection domain\r\n    if (Events.usingDomains) {\r\n      this._socket.domain = this.domain;\r\n    }\r\n\r\n    var connection = this;\r\n    this._protocol.on('data', function(data) {\r\n      connection._socket.write(data);\r\n    });\r\n    this._socket.on('data', wrapToDomain(connection, function (data) {\r\n      connection._protocol.write(data);\r\n    }));\r\n    this._protocol.on('end', function() {\r\n      connection._socket.end();\r\n    });\r\n    this._socket.on('end', wrapToDomain(connection, function () {\r\n      connection._protocol.end();\r\n    }));\r\n\r\n    this._socket.on('error', this._handleNetworkError.bind(this));\r\n    this._socket.on('connect', this._handleProtocolConnect.bind(this));\r\n    this._protocol.on('handshake', this._handleProtocolHandshake.bind(this));\r\n    this._protocol.on('initialize', this._handleProtocolInitialize.bind(this));\r\n    this._protocol.on('unhandledError', this._handleProtocolError.bind(this));\r\n    this._protocol.on('drain', this._handleProtocolDrain.bind(this));\r\n    this._protocol.on('end', this._handleProtocolEnd.bind(this));\r\n    this._protocol.on('enqueue', this._handleProtocolEnqueue.bind(this));\r\n\r\n    if (this.config.connectTimeout) {\r\n      var handleConnectTimeout = this._handleConnectTimeout.bind(this);\r\n\r\n      this._socket.setTimeout(this.config.connectTimeout, handleConnectTimeout);\r\n      this._socket.once('connect', function() {\r\n        this.setTimeout(0, handleConnectTimeout);\r\n      });\r\n    }\r\n  }\r\n\r\n  this._protocol.handshake(options, wrapCallbackInDomain(this, callback));\r\n};\r\n\r\nConnection.prototype.changeUser = function changeUser(options, callback) {\r\n  if (!callback && typeof options === 'function') {\r\n    callback = options;\r\n    options = {};\r\n  }\r\n\r\n  this._implyConnect();\r\n\r\n  var charsetNumber = (options.charset)\r\n    ? ConnectionConfig.getCharsetNumber(options.charset)\r\n    : this.config.charsetNumber;\r\n\r\n  return this._protocol.changeUser({\r\n    user          : options.user || this.config.user,\r\n    password      : options.password || this.config.password,\r\n    database      : options.database || this.config.database,\r\n    timeout       : options.timeout,\r\n    charsetNumber : charsetNumber,\r\n    currentConfig : this.config\r\n  }, wrapCallbackInDomain(this, callback));\r\n};\r\n\r\nConnection.prototype.beginTransaction = function beginTransaction(options, callback) {\r\n  if (!callback && typeof options === 'function') {\r\n    callback = options;\r\n    options = {};\r\n  }\r\n\r\n  options = options || {};\r\n  options.sql = 'START TRANSACTION';\r\n  options.values = null;\r\n\r\n  return this.query(options, callback);\r\n};\r\n\r\nConnection.prototype.commit = function commit(options, callback) {\r\n  if (!callback && typeof options === 'function') {\r\n    callback = options;\r\n    options = {};\r\n  }\r\n\r\n  options = options || {};\r\n  options.sql = 'COMMIT';\r\n  options.values = null;\r\n\r\n  return this.query(options, callback);\r\n};\r\n\r\nConnection.prototype.rollback = function rollback(options, callback) {\r\n  if (!callback && typeof options === 'function') {\r\n    callback = options;\r\n    options = {};\r\n  }\r\n\r\n  options = options || {};\r\n  options.sql = 'ROLLBACK';\r\n  options.values = null;\r\n\r\n  return this.query(options, callback);\r\n};\r\n\r\nConnection.prototype.query = function query(sql, values, cb) {\r\n  var query = Connection.createQuery(sql, values, cb);\r\n  query._connection = this;\r\n\r\n  if (!(typeof sql === 'object' && 'typeCast' in sql)) {\r\n    query.typeCast = this.config.typeCast;\r\n  }\r\n\r\n  if (query.sql) {\r\n    query.sql = this.format(query.sql, query.values);\r\n  }\r\n\r\n  if (query._callback) {\r\n    query._callback = wrapCallbackInDomain(this, query._callback);\r\n  }\r\n\r\n  this._implyConnect();\r\n\r\n  return this._protocol._enqueue(query);\r\n};\r\n\r\nConnection.prototype.ping = function ping(options, callback) {\r\n  if (!callback && typeof options === 'function') {\r\n    callback = options;\r\n    options = {};\r\n  }\r\n\r\n  this._implyConnect();\r\n  this._protocol.ping(options, wrapCallbackInDomain(this, callback));\r\n};\r\n\r\nConnection.prototype.statistics = function statistics(options, callback) {\r\n  if (!callback && typeof options === 'function') {\r\n    callback = options;\r\n    options = {};\r\n  }\r\n\r\n  this._implyConnect();\r\n  this._protocol.stats(options, wrapCallbackInDomain(this, callback));\r\n};\r\n\r\nConnection.prototype.end = function end(options, callback) {\r\n  var cb   = callback;\r\n  var opts = options;\r\n\r\n  if (!callback && typeof options === 'function') {\r\n    cb   = options;\r\n    opts = null;\r\n  }\r\n\r\n  // create custom options reference\r\n  opts = Object.create(opts || null);\r\n\r\n  if (opts.timeout === undefined) {\r\n    // default timeout of 30 seconds\r\n    opts.timeout = 30000;\r\n  }\r\n\r\n  this._implyConnect();\r\n  this._protocol.quit(opts, wrapCallbackInDomain(this, cb));\r\n};\r\n\r\nConnection.prototype.destroy = function() {\r\n  this.state = 'disconnected';\r\n  this._implyConnect();\r\n  this._socket.destroy();\r\n  this._protocol.destroy();\r\n};\r\n\r\nConnection.prototype.pause = function() {\r\n  this._socket.pause();\r\n  this._protocol.pause();\r\n};\r\n\r\nConnection.prototype.resume = function() {\r\n  this._socket.resume();\r\n  this._protocol.resume();\r\n};\r\n\r\nConnection.prototype.escape = function(value) {\r\n  return SqlString.escape(value, false, this.config.timezone);\r\n};\r\n\r\nConnection.prototype.escapeId = function escapeId(value) {\r\n  return SqlString.escapeId(value, false);\r\n};\r\n\r\nConnection.prototype.format = function(sql, values) {\r\n  if (typeof this.config.queryFormat === 'function') {\r\n    return this.config.queryFormat.call(this, sql, values, this.config.timezone);\r\n  }\r\n  return SqlString.format(sql, values, this.config.stringifyObjects, this.config.timezone);\r\n};\r\n\r\nif (tls.TLSSocket) {\r\n  // 0.11+ environment\r\n  Connection.prototype._startTLS = function _startTLS(onSecure) {\r\n    var connection = this;\r\n\r\n    createSecureContext(this.config, function (err, secureContext) {\r\n      if (err) {\r\n        onSecure(err);\r\n        return;\r\n      }\r\n\r\n      // \"unpipe\"\r\n      connection._socket.removeAllListeners('data');\r\n      connection._protocol.removeAllListeners('data');\r\n\r\n      // socket <-> encrypted\r\n      var rejectUnauthorized = connection.config.ssl.rejectUnauthorized;\r\n      var secureEstablished  = false;\r\n      var secureSocket       = new tls.TLSSocket(connection._socket, {\r\n        rejectUnauthorized : rejectUnauthorized,\r\n        requestCert        : true,\r\n        secureContext      : secureContext,\r\n        isServer           : false\r\n      });\r\n\r\n      // error handler for secure socket\r\n      secureSocket.on('_tlsError', function(err) {\r\n        if (secureEstablished) {\r\n          connection._handleNetworkError(err);\r\n        } else {\r\n          onSecure(err);\r\n        }\r\n      });\r\n\r\n      // cleartext <-> protocol\r\n      secureSocket.pipe(connection._protocol);\r\n      connection._protocol.on('data', function(data) {\r\n        secureSocket.write(data);\r\n      });\r\n\r\n      secureSocket.on('secure', function() {\r\n        secureEstablished = true;\r\n\r\n        onSecure(rejectUnauthorized ? this.ssl.verifyError() : null);\r\n      });\r\n\r\n      // start TLS communications\r\n      secureSocket._start();\r\n    });\r\n  };\r\n} else {\r\n  // pre-0.11 environment\r\n  Connection.prototype._startTLS = function _startTLS(onSecure) {\r\n    // before TLS:\r\n    //  _socket <-> _protocol\r\n    // after:\r\n    //  _socket <-> securePair.encrypted <-> securePair.cleartext <-> _protocol\r\n\r\n    var connection  = this;\r\n    var credentials = Crypto.createCredentials({\r\n      ca         : this.config.ssl.ca,\r\n      cert       : this.config.ssl.cert,\r\n      ciphers    : this.config.ssl.ciphers,\r\n      key        : this.config.ssl.key,\r\n      passphrase : this.config.ssl.passphrase\r\n    });\r\n\r\n    var rejectUnauthorized = this.config.ssl.rejectUnauthorized;\r\n    var secureEstablished  = false;\r\n    var securePair         = tls.createSecurePair(credentials, false, true, rejectUnauthorized);\r\n\r\n    // error handler for secure pair\r\n    securePair.on('error', function(err) {\r\n      if (secureEstablished) {\r\n        connection._handleNetworkError(err);\r\n      } else {\r\n        onSecure(err);\r\n      }\r\n    });\r\n\r\n    // \"unpipe\"\r\n    this._socket.removeAllListeners('data');\r\n    this._protocol.removeAllListeners('data');\r\n\r\n    // socket <-> encrypted\r\n    securePair.encrypted.pipe(this._socket);\r\n    this._socket.on('data', function(data) {\r\n      securePair.encrypted.write(data);\r\n    });\r\n\r\n    // cleartext <-> protocol\r\n    securePair.cleartext.pipe(this._protocol);\r\n    this._protocol.on('data', function(data) {\r\n      securePair.cleartext.write(data);\r\n    });\r\n\r\n    // secure established\r\n    securePair.on('secure', function() {\r\n      secureEstablished = true;\r\n\r\n      if (!rejectUnauthorized) {\r\n        onSecure();\r\n        return;\r\n      }\r\n\r\n      var verifyError = this.ssl.verifyError();\r\n      var err = verifyError;\r\n\r\n      // node.js 0.6 support\r\n      if (typeof err === 'string') {\r\n        err = new Error(verifyError);\r\n        err.code = verifyError;\r\n      }\r\n\r\n      onSecure(err);\r\n    });\r\n\r\n    // node.js 0.8 bug\r\n    securePair._cycle = securePair.cycle;\r\n    securePair.cycle  = function cycle() {\r\n      if (this.ssl && this.ssl.error) {\r\n        this.error();\r\n      }\r\n\r\n      return this._cycle.apply(this, arguments);\r\n    };\r\n  };\r\n}\r\n\r\nConnection.prototype._handleConnectTimeout = function() {\r\n  if (this._socket) {\r\n    this._socket.setTimeout(0);\r\n    this._socket.destroy();\r\n  }\r\n\r\n  var err = new Error('connect ETIMEDOUT');\r\n  err.errorno = 'ETIMEDOUT';\r\n  err.code = 'ETIMEDOUT';\r\n  err.syscall = 'connect';\r\n\r\n  this._handleNetworkError(err);\r\n};\r\n\r\nConnection.prototype._handleNetworkError = function(err) {\r\n  this._protocol.handleNetworkError(err);\r\n};\r\n\r\nConnection.prototype._handleProtocolError = function(err) {\r\n  this.state = 'protocol_error';\r\n  this.emit('error', err);\r\n};\r\n\r\nConnection.prototype._handleProtocolDrain = function() {\r\n  this.emit('drain');\r\n};\r\n\r\nConnection.prototype._handleProtocolConnect = function() {\r\n  this.state = 'connected';\r\n  this.emit('connect');\r\n};\r\n\r\nConnection.prototype._handleProtocolHandshake = function _handleProtocolHandshake() {\r\n  this.state = 'authenticated';\r\n};\r\n\r\nConnection.prototype._handleProtocolInitialize = function _handleProtocolInitialize(packet) {\r\n  this.threadId = packet.threadId;\r\n};\r\n\r\nConnection.prototype._handleProtocolEnd = function(err) {\r\n  this.state = 'disconnected';\r\n  this.emit('end', err);\r\n};\r\n\r\nConnection.prototype._handleProtocolEnqueue = function _handleProtocolEnqueue(sequence) {\r\n  this.emit('enqueue', sequence);\r\n};\r\n\r\nConnection.prototype._implyConnect = function() {\r\n  if (!this._connectCalled) {\r\n    this.connect();\r\n  }\r\n};\r\n\r\nfunction createSecureContext (config, cb) {\r\n  var context = null;\r\n  var error   = null;\r\n\r\n  try {\r\n    context = tls.createSecureContext({\r\n      ca         : config.ssl.ca,\r\n      cert       : config.ssl.cert,\r\n      ciphers    : config.ssl.ciphers,\r\n      key        : config.ssl.key,\r\n      passphrase : config.ssl.passphrase\r\n    });\r\n  } catch (err) {\r\n    error = err;\r\n  }\r\n\r\n  cb(error, context);\r\n}\r\n\r\nfunction unwrapFromDomain(fn) {\r\n  return function () {\r\n    var domains = [];\r\n    var ret;\r\n\r\n    while (process.domain) {\r\n      domains.shift(process.domain);\r\n      process.domain.exit();\r\n    }\r\n\r\n    try {\r\n      ret = fn.apply(this, arguments);\r\n    } finally {\r\n      for (var i = 0; i < domains.length; i++) {\r\n        domains[i].enter();\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  };\r\n}\r\n\r\nfunction wrapCallbackInDomain(ee, fn) {\r\n  if (typeof fn !== 'function') {\r\n    return undefined;\r\n  }\r\n\r\n  if (fn.domain) {\r\n    return fn;\r\n  }\r\n\r\n  var domain = process.domain;\r\n\r\n  if (domain) {\r\n    return domain.bind(fn);\r\n  } else if (ee) {\r\n    return unwrapFromDomain(wrapToDomain(ee, fn));\r\n  } else {\r\n    return fn;\r\n  }\r\n}\r\n\r\nfunction wrapToDomain(ee, fn) {\r\n  return function () {\r\n    if (Events.usingDomains && ee.domain) {\r\n      ee.domain.enter();\r\n      fn.apply(this, arguments);\r\n      ee.domain.exit();\r\n    } else {\r\n      fn.apply(this, arguments);\r\n    }\r\n  };\r\n}\r\n"]},"metadata":{},"sourceType":"script"}